name: CI-Scripts
on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - ".github/workflows/*"
      - "CI/*"
      - "Scripts/*"
      - "**.c"
      - "**.cpp"
      - "**.h"
      - "**.hpp"

jobs:
  Build-targets:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ssciwr/doxygen-install@v1
      - uses: seanmiddleditch/gha-setup-ninja@master
      - uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: "3.25.x"

      - name: Build target specific code
        shell: bash
        run: bash CI/BuildAllTargetSpecific.sh

  Test-all:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - uses: ssciwr/doxygen-install@v1
      - uses: seanmiddleditch/gha-setup-ninja@master
      - uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: "3.25.x"

      - name: Test all
        shell: bash
        run: bash CI/TestAll.sh

      - uses: EndBug/add-and-commit@v9
        with:
          add: Coverage/coverage.svg
          message: "github-action: update coverage badge"
          default_author: github_actions

      - uses: VeryGoodOpenSource/very_good_coverage@v2
        with:
          path: "Coverage/coverage.info"
          min_coverage: 80

  Generate-Doxygen:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ssciwr/doxygen-install@v1
      - uses: seanmiddleditch/gha-setup-ninja@master
      - uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: "3.25.x"

      - name: Generate doxygen
        shell: bash
        run: bash CI/GenerateDoxygen.sh
